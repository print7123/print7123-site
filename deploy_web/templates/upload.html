{% extends "base.html" %}

{% block title %}파일업로드 - 온누리인쇄나라{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-primary">
                    <i class="fas fa-upload me-3"></i>파일 업로드
                </h1>
                <p class="lead text-muted">인쇄할 파일을 안전하게 업로드하세요.</p>
            </div>

            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <form method="POST" enctype="multipart/form-data" id="uploadForm">
                        <!-- 파일 선택 -->
                        <div class="mb-4">
                            <label for="file" class="form-label fw-bold">
                                <i class="fas fa-file me-2"></i>파일 선택
                            </label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="file" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.tiff,.ai,.eps" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('file').click()">
                                    <i class="fas fa-folder-open me-2"></i>찾아보기
                                </button>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                지원 형식: PDF, DOC, DOCX, JPG, PNG, TIFF, AI, EPS (최대 50MB)
                            </div>
                        </div>

                        <!-- 파일 정보 표시 -->
                        <div id="fileInfo" class="mb-4" style="display: none;">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">
                                    <i class="fas fa-file-alt me-2"></i>선택된 파일 정보
                                </h6>
                                <div id="fileDetails"></div>
                            </div>
                        </div>

                        <!-- 주문 정보 -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-shopping-cart me-2"></i>주문 정보
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="orderNumber" class="form-label">주문번호 (선택사항)</label>
                                    <input type="text" class="form-control" id="orderNumber" name="orderNumber" placeholder="기존 주문번호가 있다면 입력하세요">
                                </div>
                                <div class="col-md-6">
                                    <label for="urgency" class="form-label">긴급도</label>
                                    <select class="form-select" id="urgency" name="urgency">
                                        <option value="일반">일반 (3-5일)</option>
                                        <option value="긴급">긴급 (1-2일)</option>
                                        <option value="특급">특급 (당일)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 특별 요구사항 -->
                        <div class="mb-4">
                            <label for="requirements" class="form-label fw-bold">
                                <i class="fas fa-comment me-2"></i>특별 요구사항
                            </label>
                            <textarea class="form-control" id="requirements" name="requirements" rows="4" placeholder="인쇄 관련 특별한 요구사항이 있으시면 입력해주세요.&#10;예: 특수 용지, 후가공, 특정 색상 등"></textarea>
                        </div>

                        <!-- 연락처 정보 -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-phone me-2"></i>연락처 정보
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="contactName" class="form-label">연락처명</label>
                                    <input type="text" class="form-control" id="contactName" name="contactName" value="{{ current_user.username }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="contactPhone" class="form-label">연락처</label>
                                    <input type="tel" class="form-control" id="contactPhone" name="contactPhone" value="{{ current_user.phone }}" required>
                                </div>
                            </div>
                        </div>

                        <!-- 업로드 버튼 -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="resetForm()">
                                <i class="fas fa-redo me-2"></i>초기화
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                                <i class="fas fa-upload me-2"></i>파일 업로드
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 업로드 가이드 -->
            <div class="card mt-4 border-0 bg-light">
                <div class="card-body">
                    <h6 class="card-title text-primary">
                        <i class="fas fa-info-circle me-2"></i>파일 업로드 가이드
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold">권장 사항</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>PDF 형식 권장</li>
                                <li><i class="fas fa-check text-success me-2"></i>300DPI 이상 해상도</li>
                                <li><i class="fas fa-check text-success me-2"></i>CMYK 색상 모드</li>
                                <li><i class="fas fa-check text-success me-2"></i>여백 3mm 이상</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">주의사항</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>파일명에 특수문자 사용 금지</li>
                                <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>50MB 이하 파일만 업로드 가능</li>
                                <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>업로드 후 파일 검토 필요</li>
                                <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>개인정보 포함 시 암호화 권장</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 업로드 히스토리 -->
            <div class="card mt-4 border-0">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>최근 업로드 파일
                    </h6>
                </div>
                <div class="card-body">
                    <div id="uploadHistory">
                        <p class="text-muted text-center">업로드된 파일이 없습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 파일 선택 시 정보 표시
document.getElementById('file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const fileInfo = document.getElementById('fileInfo');
        const fileDetails = document.getElementById('fileDetails');
        
        // 파일 크기 포맷팅
        const formatFileSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };
        
        // 파일 정보 표시
        fileDetails.innerHTML = `
            <p class="mb-1"><strong>파일명:</strong> ${file.name}</p>
            <p class="mb-1"><strong>크기:</strong> ${formatFileSize(file.size)}</p>
            <p class="mb-1"><strong>형식:</strong> ${file.type || '알 수 없음'}</p>
            <p class="mb-0"><strong>수정일:</strong> ${new Date(file.lastModified).toLocaleString()}</p>
        `;
        
        fileInfo.style.display = 'block';
        
        // 파일 크기 검증
        if (file.size > 50 * 1024 * 1024) { // 50MB
            alert('파일 크기가 50MB를 초과합니다. 더 작은 파일을 선택해주세요.');
            e.target.value = '';
            fileInfo.style.display = 'none';
        }
    } else {
        document.getElementById('fileInfo').style.display = 'none';
    }
});

// 폼 제출 처리
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('file');
    const uploadBtn = document.getElementById('uploadBtn');
    
    if (!fileInput.files[0]) {
        alert('파일을 선택해주세요.');
        return;
    }
    
    // 업로드 버튼 비활성화
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>업로드 중...';
    
    // 폼 데이터 생성
    const formData = new FormData(this);
    
    // 업로드 진행
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.text();
        }
        throw new Error('업로드 실패');
    })
    .then(() => {
        alert('파일이 성공적으로 업로드되었습니다.');
        resetForm();
        loadUploadHistory();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('파일 업로드 중 오류가 발생했습니다.');
    })
    .finally(() => {
        // 업로드 버튼 복원
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>파일 업로드';
    });
});

function resetForm() {
    document.getElementById('uploadForm').reset();
    document.getElementById('fileInfo').style.display = 'none';
}

function loadUploadHistory() {
    // 업로드 히스토리 로드 (실제 구현에서는 서버에서 데이터를 가져옴)
    const historyDiv = document.getElementById('uploadHistory');
    historyDiv.innerHTML = '<p class="text-muted text-center">업로드된 파일이 없습니다.</p>';
}

// 페이지 로드 시 히스토리 로드
document.addEventListener('DOMContentLoaded', function() {
    loadUploadHistory();
});
</script>
{% endblock %} 