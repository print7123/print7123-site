{% extends "base.html" %}

{% block title %}메일 검색 결과 - 온누리인쇄나라{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-search"></i> 메일 검색 결과</h2>
                <a href="{{ url_for('mail_inbox') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 메일함으로 돌아가기
                </a>
            </div>

            <!-- 검색 정보 -->
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>"{{ query }}"</strong>에 대한 검색 결과: <strong>{{ emails|length }}개</strong>의 메일을 찾았습니다.
            </div>

            {% if emails %}
            <!-- 검색 결과 테이블 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-envelope"></i> 검색 결과</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" id="select-all" class="form-check-input">
                                    </th>
                                    <th width="100">상태</th>
                                    <th width="120">우선순위</th>
                                    <th width="150">보낸사람</th>
                                    <th>제목</th>
                                    <th width="120">카테고리</th>
                                    <th width="150">수신일시</th>
                                    <th width="100">첨부</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for email in emails %}
                                <tr class="{% if email.status == 'unread' %}table-warning{% endif %}">
                                    <td>
                                        <input type="checkbox" name="email_ids" value="{{ email.id }}" class="form-check-input email-checkbox">
                                    </td>
                                    <td>
                                        {% if email.status == 'unread' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-envelope"></i> 읽지않음
                                            </span>
                                        {% elif email.status == 'read' %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-envelope-open"></i> 읽음
                                            </span>
                                        {% elif email.status == 'replied' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-reply"></i> 답장함
                                            </span>
                                        {% elif email.status == 'archived' %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-archive"></i> 보관
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if email.priority == 'urgent' %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-exclamation-triangle"></i> 긴급
                                            </span>
                                        {% elif email.priority == 'high' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-arrow-up"></i> 높음
                                            </span>
                                        {% elif email.priority == 'low' %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-arrow-down"></i> 낮음
                                            </span>
                                        {% else %}
                                            <span class="badge bg-primary">보통</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ email.sender_name or '이름 없음' }}</strong>
                                        </div>
                                        <small class="text-muted">{{ email.sender_email }}</small>
                                    </td>
                                    <td>
                                        <a href="{{ url_for('mail_view', email_id=email.id) }}" class="text-decoration-none">
                                            {{ email.subject }}
                                        </a>
                                        {% if email.attachments %}
                                            <i class="fas fa-paperclip text-muted ms-1"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if email.category == 'quote' %}
                                            <span class="badge bg-primary">견적 문의</span>
                                        {% elif email.category == 'order' %}
                                            <span class="badge bg-success">주문 문의</span>
                                        {% elif email.category == 'general' %}
                                            <span class="badge bg-secondary">일반 문의</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ email.category }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ email.received_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </td>
                                    <td>
                                        {% if email.attachments %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-paperclip"></i> {{ email.attachments|length }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 일괄 작업 버튼 -->
            <div class="mt-3">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="bulkAction('mark_read')">
                        <i class="fas fa-check"></i> 읽음 표시
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="bulkAction('archive')">
                        <i class="fas fa-archive"></i> 보관
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="bulkAction('delete')">
                        <i class="fas fa-trash"></i> 삭제
                    </button>
                </div>
            </div>

            {% else %}
            <!-- 검색 결과 없음 -->
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">검색 결과가 없습니다</h4>
                <p class="text-muted">다른 검색어를 사용해보세요.</p>
                <a href="{{ url_for('mail_inbox') }}" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> 메일함으로 돌아가기
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 일괄 작업 폼 -->
<form id="bulk-action-form" method="POST" action="{{ url_for('mail_bulk_action') }}" style="display: none;">
    <input type="hidden" name="action" id="bulk-action-type">
    <div id="bulk-action-email-ids"></div>
</form>

<script>
// 전체 선택/해제
document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

// 일괄 작업 함수
function bulkAction(action) {
    const selectedEmails = document.querySelectorAll('.email-checkbox:checked');
    
    if (selectedEmails.length === 0) {
        alert('선택된 메일이 없습니다.');
        return;
    }
    
    let confirmMessage = '';
    switch(action) {
        case 'mark_read':
            confirmMessage = '선택된 메일을 읽음으로 표시하시겠습니까?';
            break;
        case 'archive':
            confirmMessage = '선택된 메일을 보관하시겠습니까?';
            break;
        case 'delete':
            confirmMessage = '선택된 메일을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.';
            break;
    }
    
    if (confirm(confirmMessage)) {
        const form = document.getElementById('bulk-action-form');
        const actionInput = document.getElementById('bulk-action-type');
        const emailIdsDiv = document.getElementById('bulk-action-email-ids');
        
        actionInput.value = action;
        emailIdsDiv.innerHTML = '';
        
        selectedEmails.forEach(checkbox => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'email_ids';
            input.value = checkbox.value;
            emailIdsDiv.appendChild(input);
        });
        
        form.submit();
    }
}
</script>
{% endblock %} 